#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

ensure_image() {
    if ! docker image inspect sandbox:latest >/dev/null 2>&1; then
        echo "Building sandbox container..." >&2
        docker build -t sandbox "$SCRIPT_DIR"
    fi
}

usage() {
    echo "Usage: $0 [OPTIONS] AGENT [AGENT_ARGS]"
    echo ""
    echo "Options:"
    echo "  -d DIR    Working directory (default: current directory)"
    echo "  -h        Show this help message"
    echo ""
    echo "Agents:"
    echo "  claude    Anthropic Claude"
    echo "  opencode  OpenCode"
    echo "  codex     OpenAI Codex"
    echo "  goose     Goose"
    echo "  gemini    Google Gemini"
    exit 1
}

WORKDIR="$(pwd)"
AGENT=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        -d)
            WORKDIR="$2"
            shift 2
            ;;
        -h|--help)
            usage
            ;;
        -*)
            echo "Unknown option: $1"
            usage
            ;;
        *)
            AGENT="$1"
            shift
            break
            ;;
    esac
done

if [[ -z "$AGENT" ]]; then
    echo "Error: AGENT is required"
    usage
fi

AGENT_CONFIG="$SCRIPT_DIR/agents/${AGENT}.yml"
if [[ ! -f "$AGENT_CONFIG" ]]; then
    echo "Error: Unknown agent: $AGENT"
    echo "Available agents: claude, opencode, codex, goose, gemini"
    exit 1
fi

CONFIG="$SCRIPT_DIR/config.yml"
INTERNET=$(grep "^internet:" "$CONFIG" | awk '{print $2}')
FEEDBACK=$(grep "^feedback:" "$CONFIG" | awk '{print $2}')

ensure_image

if [[ "$FEEDBACK" == "minimal" ]]; then
    echo "Launching agent..." >&2
fi

TOOLS=$(grep "^  tools:" -A 10 "$AGENT_CONFIG" | grep "^  -" | sed 's/^  - //')

DOCKER_CMD="docker run --rm"
DOCKER_CMD="$DOCKER_CMD --cap-drop ALL --cap-add CHOWN --cap-add DAC_OVERRIDE"
DOCKER_CMD="$DOCKER_CMD --no-new-privileges"

if [[ "$INTERNET" != "true" ]]; then
    DOCKER_CMD="$DOCKER_CMD --network none"
fi

DOCKER_CMD="$DOCKER_CMD -v '$WORKDIR:/workspace'"
DOCKER_CMD="$DOCKER_CMD -v sandbox-credentials:/home/agent/.config"
DOCKER_CMD="$DOCKER_CMD -w /workspace"
DOCKER_CMD="$DOCKER_CMD sandbox:latest"

TOOLS_ARG=$(echo "$TOOLS" | tr '\n' ',' | sed 's/,$//')
eval "$DOCKER_CMD" "$AGENT" "$@" --tools "$TOOLS_ARG"
